<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Поиск адресов в базе МКД</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4a6fa5 0%, #2c3e50 100%); color: white; padding: 30px 40px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 300; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .search-section { padding: 40px; border-bottom: 1px solid #eee; }
        .search-box { position: relative; max-width: 800px; margin: 0 auto; }
        #searchInput { width: 100%; padding: 20px 25px; font-size: 1.2em; border: 2px solid #ddd; border-radius: 50px; outline: none; transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        #searchInput:focus { border-color: #4a6fa5; box-shadow: 0 5px 25px rgba(74, 111, 165, 0.3); }
        .search-icon { position: absolute; right: 25px; top: 50%; transform: translateY(-50%); color: #667eea; font-size: 1.5em; }
        .results-section { padding: 20px 40px; display: none; }
        .results-container { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px; padding: 10px; margin-top: 20px; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05); }
        .result-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: all 0.2s ease; border-radius: 5px; }
        .result-item:hover { background: #f8f9ff; transform: translateX(5px); }
        .result-item:last-child { border-bottom: none; }
        .result-address { font-size: 1.1em; color: #333; margin-bottom: 5px; }
        .result-guid { font-size: 0.9em; color: #666; font-family: monospace; }
        .info-section { padding: 40px; display: none; }
        .info-card { background: #f8f9ff; border-radius: 10px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .info-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #eaeaea; }
        .info-title { font-size: 1.8em; color: #2c3e50; }
        .back-btn { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-size: 1em; transition: all 0.3s ease; }
        .back-btn:hover { background: #5a67d8; transform: translateY(-2px); }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .info-item { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); }
        .info-label { font-weight: 600; color: #667eea; margin-bottom: 8px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-value { font-size: 1.2em; color: #333; word-break: break-word; }
        .loading { text-align: center; padding: 20px; color: #667eea; font-size: 1.1em; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
        .empty-state i { font-size: 3em; margin-bottom: 20px; opacity: 0.5; }
        .stats { text-align: center; padding: 15px; background: #f8f9ff; border-radius: 0 0 15px 15px; font-size: 0.9em; color: #666; }
        @media (max-width: 768px) { 
            .container { margin: 10px; }
            .header, .search-section, .results-section, .info-section { padding: 20px; }
            .info-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2em; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-building"></i> База данных МКД</h1>
            <p>Поиск по адресам многоквартирных домов</p>
        </div>
        
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" 
                       placeholder="Введите улицу, город или часть адреса (минимум 2 символа)..."
                       autocomplete="off">
                <div class="search-icon"><i class="fas fa-search"></i></div>
            </div>
        </div>
        
        <div class="results-section" id="resultsSection">
            <h3>Результаты поиска:</h3>
            <div class="results-container" id="resultsContainer"></div>
        </div>
        
        <div class="info-section" id="infoSection">
            <div class="info-card">
                <div class="info-header">
                    <h2 class="info-title">Информация об адресе</h2>
                    <button class="back-btn" onclick="goBackToSearch()">
                        <i class="fas fa-arrow-left"></i> Назад к поиску
                    </button>
                </div>
                <div class="info-grid" id="infoGrid"></div>
            </div>
        </div>
        
        <div class="stats" id="stats">Загрузка статистики...</div>
    </div>

    <script>
        let debounceTimer;
        document.addEventListener('DOMContentLoaded', loadStats);
        
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(debounceTimer);
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                document.getElementById('resultsSection').style.display = 'none';
                return;
            }
            
            debounceTimer = setTimeout(() => searchAddresses(query), 300);
        });
        
        async function searchAddresses(query) {
            showLoading();
            try {
                const response = await fetch(`/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                displayResults(data.results);
            } catch (error) {
                console.error('Ошибка поиска:', error);
                showError('Ошибка при поиске адресов');
            }
        }
        
        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            const resultsSection = document.getElementById('resultsSection');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>По вашему запросу ничего не найдено</p>
                        <p>Попробуйте изменить поисковый запрос</p>
                    </div>
                `;
            } else {
                container.innerHTML = results.map(result => `
                    <div class="result-item" onclick="selectAddress('${result.houseguid}')">
                        <div class="result-address">${result.address}</div>
                        <div class="result-guid">Код ФИАС: ${result.houseguid || 'не указан'}</div>
                    </div>
                `).join('');
            }
            
            resultsSection.style.display = 'block';
            document.getElementById('infoSection').style.display = 'none';
        }
        
        async function selectAddress(houseguid) {
            showLoading();
            try {
                const response = await fetch(`/address/${houseguid}`);
                if (!response.ok) throw new Error('Адрес не найден');
                const data = await response.json();
                displayAddressInfo(data);
            } catch (error) {
                console.error('Ошибка загрузки адреса:', error);
                showError('Не удалось загрузить информацию об адресе');
            }
        }
        
        function displayAddressInfo(info) {
            const infoGrid = document.getElementById('infoGrid');
            const infoSection = document.getElementById('infoSection');
            const resultsSection = document.getElementById('resultsSection');
            
            infoGrid.innerHTML = `
                <div class="info-item"><div class="info-label">Полный адрес</div><div class="info-value">${info.address}</div></div>
                <div class="info-item"><div class="info-label">Код ФИАС</div><div class="info-value">${info.houseguid}</div></div>
                <div class="info-item"><div class="info-label">Год постройки</div><div class="info-value">${info.built_year}</div></div>
                <div class="info-item"><div class="info-label">Общая площадь</div><div class="info-value">${info.area_total}</div></div>
                <div class="info-item"><div class="info-label">Материал фундамента</div><div class="info-value">${info.foundation_type}</div></div>
                <div class="info-item"><div class="info-label">Материал стен</div><div class="info-value">${info.wall_material}</div></div>
                <div class="info-item"><div class="info-label">Теплоснабжение</div><div class="info-value">${info.heating_type}</div></div>
                <div class="info-item"><div class="info-label">Водоснабжение</div><div class="info-value">${info.hot_water_type}</div></div>
                <div class="info-item"><div class="info-label">Газоснабжение</div><div class="info-value">${info.gas_type}</div></div>
            `;
            
            infoSection.style.display = 'block';
            resultsSection.style.display = 'none';
        }
        
        function goBackToSearch() {
            document.getElementById('infoSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('searchInput').focus();
        }
        
        function showLoading() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Загрузка...</p></div>`;
        }
        
        function showError(message) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>${message}</p></div>`;
        }
        
        async function loadStats() {
            try {
                const response = await fetch('/stats');
                const data = await response.json();
                document.getElementById('stats').textContent = data.has_data ? 
                    `Загружено записей: ${data.total_records}` : 'Данные не загружены';
            } catch (error) {
                document.getElementById('stats').textContent = 'Ошибка загрузки статистики';
            }
        }
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.getElementById('searchInput').value = '';
                document.getElementById('resultsSection').style.display = 'none';
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });
    </script>
</body>
</html>
